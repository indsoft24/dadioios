name: Build iOS App

on:
  push:
    branches: [ main, develop, dev ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allows manual triggering

jobs:
  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install npm dependencies
        run: |
          npm cache clean --force
          npm install --legacy-peer-deps
          npm config set legacy-peer-deps true

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          pod --version

      - name: Install CocoaPods dependencies
        working-directory: ./ios
        run: |
          # Clean previous pod installations to ensure fresh setup
          rm -rf Pods Podfile.lock
          # Install pods (this will apply our Podfile fixes)
          pod install --repo-update

      - name: List available simulators
        run: |
          xcrun simctl list devices available

      - name: Build iOS App (Debug - Simulator)
        working-directory: ./ios
        run: |
          # Clean build folder
          rm -rf build
          # Build for simulator
          xcodebuild -workspace Dadio.xcworkspace \
            -scheme Dadio \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO \
            clean build

      - name: Archive iOS (Release)
        if: github.event_name == 'workflow_dispatch'
        working-directory: ./ios
        run: |
          xcodebuild -workspace Dadio.xcworkspace \
            -scheme Dadio \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath ./build/Dadio.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            clean archive
        continue-on-error: true

      - name: Export IPA (if archive exists)
        if: github.event_name == 'workflow_dispatch' && success()
        working-directory: ./ios
        run: |
          if [ -d "build/Dadio.xcarchive" ]; then
            echo "‚úÖ Archive created successfully at build/Dadio.xcarchive"
            echo "üì¶ Archive is available for download in artifacts"
            # IPA export would require export options plist and signing
            # For now, the archive is available for download
          else
            echo "‚ö†Ô∏è Archive not found"
          fi
        continue-on-error: true

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ github.run_number }}
          path: |
            ios/build/
            ios/Pods/
          retention-days: 7
          if-no-files-found: ignore

      - name: Build summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ iOS build completed successfully!"
            echo "üì± Download artifacts from the Actions tab"
            echo "üì¶ Build artifacts will be available for 7 days"
          else
            echo "‚ùå iOS build failed"
            echo "Check the logs above for details"
          fi
          echo ""
          echo "Project: Dadio iOS"
          echo "Workspace: ios/Dadio.xcworkspace"
          echo "Scheme: Dadio"
          echo "Configuration: Debug"
